<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>润藏命理 - 专业命理分析服务</title>
    <style>
        :root {
            --primary-color: #6a1b9a;
            --secondary-color: #9c27b0;
            --accent-color: #e1bee7;
            --text-color: #333;
            --light-bg: #f5f5f5;
            --white: #ffffff;
            --error-color: #f44336;
            --success-color: #4caf50;
            --shadow: 0 5px 15px rgba(0,0,0,0.05);
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
        }
        
        body {
            background-color: var(--light-bg);
            color: var(--text-color);
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        section {
            padding: 80px 0;
        }
        
        h1, h2, h3, h4 {
            color: var(--primary-color);
            margin-bottom: 20px;
        }
        
        p {
            margin-bottom: 15px;
        }
        
        .btn {
            display: inline-block;
            padding: 12px 30px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: var(--transition);
            text-decoration: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        /* 导航栏样式 */
        header {
            background-color: var(--white);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .nav-links {
            display: flex;
            list-style: none;
        }
        
        .nav-links li {
            margin-left: 30px;
        }
        
        .nav-links a {
            text-decoration: none;
            color: var(--text-color);
            font-weight: 500;
            transition: var(--transition);
        }
        
        .nav-links a:hover {
            color: var(--primary-color);
        }
        
        /* 英雄区域 */
        .hero {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            text-align: center;
            padding: 120px 0;
            position: relative;
            overflow: hidden;
        }
        
        .hero::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none"><path d="M0,0 L100,0 L100,100 Z" fill="rgba(255,255,255,0.1)"/></svg>');
            background-size: cover;
        }
        
        .hero-content {
            position: relative;
            z-index: 1;
        }
        
        .hero h1 {
            font-size: 3.5rem;
            margin-bottom: 20px;
            color: white;
            text-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .hero p {
            font-size: 1.3rem;
            max-width: 700px;
            margin: 0 auto 30px;
            opacity: 0.9;
        }
        
        /* 服务卡片样式 */
        .services {
            background-color: var(--white);
        }
        
        .section-title {
            text-align: center;
            margin-bottom: 60px;
        }
        
        .section-title h2 {
            position: relative;
            display: inline-block;
            padding-bottom: 15px;
        }
        
        .section-title h2::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 3px;
            background-color: var(--primary-color);
        }
        
        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 30px;
        }
        
        .service-card {
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 30px;
            text-align: center;
            transition: var(--transition);
            border-top: 4px solid var(--primary-color);
        }
        
        .service-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.1);
        }
        
        .service-card h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        
        .price {
            font-size: 2rem;
            color: var(--secondary-color);
            font-weight: bold;
            margin: 15px 0;
        }
        
        .service-features {
            list-style: none;
            text-align: left;
            margin: 20px 0;
        }
        
        .service-features li {
            margin-bottom: 10px;
            padding-left: 20px;
            position: relative;
        }
        
        .service-features li::before {
            content: "✓";
            position: absolute;
            left: 0;
            color: var(--secondary-color);
            font-weight: bold;
        }
        
        /* 表单样式 */
        .form-container {
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 40px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .required::after {
            content: " *";
            color: var(--error-color);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            transition: var(--transition);
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(106, 27, 154, 0.2);
        }
        
        .error {
            color: var(--error-color);
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .payment-options {
            display: flex;
            gap: 20px;
            margin-top: 30px;
        }
        
        .payment-option {
            flex: 1;
            text-align: center;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .payment-option.active {
            border-color: var(--primary-color);
            background-color: rgba(106, 27, 154, 0.05);
        }
        
        .payment-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 60px;
        }
        
        .payment-icon img {
            max-width: 100%;
            max-height: 40px;
        }
        
        /* 支付弹窗样式 - 移动端优化 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }
        
        .modal-content {
            background-color: var(--white);
            margin: 5% auto;
            padding: 30px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            width: 90%;
            max-width: 500px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        
        .close:hover {
            color: var(--text-color);
        }
        
        .qr-codes {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }
        
        .qr-code {
            text-align: center;
        }
        
        .qr-code img {
            width: 260px;
            height: 260px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        /* 加载动画 - 优化后的简化版本 */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 分析过程样式 - 优化后的简化版本 */
        .analysis-process {
            display: none;
            text-align: center;
            padding: 60px 20px;
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: var(--shadow);
            max-width: 800px;
            margin: 0 auto;
            min-height: 400px;
        }
        
        .analysis-steps {
            text-align: center;
            margin: 40px 0;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .analysis-step {
            margin-bottom: 15px;
            padding: 12px 15px;
            background-color: rgba(106, 27, 154, 0.05);
            border-radius: 6px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: flex-start;
        }
        
        .analysis-step.completed {
            background-color: rgba(76, 175, 80, 0.1);
            border-left: 4px solid var(--success-color);
        }
        
        .analysis-step.active {
            background-color: rgba(156, 39, 176, 0.1);
            border-left: 4px solid var(--secondary-color);
        }
        
        .step-icon {
            display: inline-block;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #ddd;
            color: white;
            text-align: center;
            line-height: 24px;
            margin-right: 12px;
            flex-shrink: 0;
        }
        
        .analysis-step.completed .step-icon {
            background-color: var(--success-color);
        }
        
        .analysis-step.active .step-icon {
            background-color: var(--secondary-color);
        }
        
        /* 分析结果样式 - 优化后的样式 */
        .analysis-result {
            display: none;
            text-align: left;
            margin-top: 30px;
            padding: 30px;
            background-color: rgba(225, 190, 231, 0.1);
            border-radius: 8px;
            border: 1px solid var(--accent-color);
            white-space: pre-wrap;
            font-size: 16px;
            line-height: 1.8;
            max-height: 600px;
            overflow-y: auto;
            font-family: 'Microsoft YaHei', 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
        }

        .analysis-result-content {
            font-size: 16px;
            line-height: 1.8;
            color: #333;
        }

        .analysis-result-content h3 {
            color: var(--primary-color);
            margin: 25px 0 15px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--accent-color);
            font-size: 18px;
            font-weight: 600;
        }

        .analysis-result-content p {
            margin-bottom: 15px;
            text-indent: 2em;
        }

        .analysis-result-content ul {
            margin: 15px 0;
            padding-left: 30px;
        }

        .analysis-result-content li {
            margin-bottom: 8px;
            position: relative;
        }

        .analysis-result-content li:before {
            content: "•";
            color: var(--secondary-color);
            font-weight: bold;
            position: absolute;
            left: -15px;
        }

        .analysis-section {
            margin-bottom: 25px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 6px;
            border-left: 4px solid var(--primary-color);
        }

        .report-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--accent-color);
        }

        .report-header h2 {
            color: var(--primary-color);
            font-size: 24px;
            margin-bottom: 10px;
        }

        .report-meta {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .result-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .word-count {
            text-align: center;
            margin-top: 15px;
            color: #666;
            font-size: 14px;
        }
        
        /* 成功消息 */
        .success-message {
            display: none;
            text-align: center;
            padding: 40px;
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: var(--shadow);
            max-width: 800px;
            margin: 0 auto;
        }
        
        .success-icon {
            font-size: 4rem;
            color: var(--success-color);
            margin-bottom: 20px;
        }
        
        /* 页脚样式 */
        footer {
            background-color: #2c2c2c;
            color: white;
            padding: 60px 0 20px;
        }
        
        .footer-content {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin-bottom: 40px;
        }
        
        .footer-column {
            flex: 1;
            min-width: 250px;
            margin-bottom: 30px;
        }
        
        .footer-column h3 {
            color: white;
            margin-bottom: 20px;
        }
        
        .footer-links {
            list-style: none;
        }
        
        .footer-links li {
            margin-bottom: 10px;
        }
        
        .footer-links a {
            color: #ddd;
            text-decoration: none;
            transition: var(--transition);
        }
        
        .footer-links a:hover {
            color: var(--accent-color);
        }
        
        .copyright {
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid #444;
        }
        
        /* 收款码样式优化 */
        .payment-status {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }

        .payment-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            position: sticky;
            bottom: 0;
            background-color: var(--white);
            padding: 15px 0;
            border-top: 1px solid #eee;
        }

        .order-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .order-info p {
            margin-bottom: 8px;
        }
        
        /* 响应式设计 - 移动端优化 */
        @media (max-width: 768px) {
            .navbar {
                flex-direction: column;
            }
            
            .nav-links {
                margin-top: 20px;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .nav-links li {
                margin: 0 10px 10px;
            }
            
            .hero h1 {
                font-size: 2.2rem;
            }
            
            .hero p {
                font-size: 1.1rem;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .payment-options {
                flex-direction: column;
            }
            
            section {
                padding: 60px 0;
            }
            
            .qr-codes {
                flex-direction: column;
                gap: 20px;
            }
            
            .modal-content {
                width: 95%;
                margin: 5% auto;
                padding: 20px;
                max-height: 95vh;
            }
            
            .result-actions {
                flex-direction: column;
            }
            
            /* 移动端支付弹窗优化 */
            .qr-code img {
                width: 220px;
                height: 220px;
            }
            
            .payment-actions {
                position: sticky;
                bottom: 0;
                background-color: var(--white);
                padding: 15px 0;
                border-top: 1px solid #eee;
                z-index: 10;
            }
            
            .modal-body {
                padding-bottom: 80px; /* 为固定按钮留出空间 */
            }
            
            /* 移动端表单优化 */
            .form-container {
                padding: 20px;
            }
            
            .service-card {
                padding: 20px;
            }

            .analysis-result {
                padding: 20px;
                font-size: 15px;
            }

            .analysis-process {
                padding: 40px 15px;
                min-height: 300px;
            }

            .analysis-steps {
                margin: 30px 0;
            }
        }
        
        @media (max-width: 480px) {
            .hero {
                padding: 80px 0;
            }
            
            .hero h1 {
                font-size: 1.8rem;
            }
            
            .hero p {
                font-size: 1rem;
            }
            
            .section-title h2 {
                font-size: 1.5rem;
            }
            
            .price {
                font-size: 1.5rem;
            }
            
            .qr-code img {
                width: 200px;
                height: 200px;
            }
            
            .btn {
                padding: 10px 20px;
                font-size: 14px;
            }

            .analysis-process {
                padding: 30px 10px;
            }
        }
        
        /* 固定金额二维码样式 */
        .fixed-amount-info {
            text-align: center;
            margin: 15px 0;
            padding: 10px;
            background-color: #e8f5e9;
            border-radius: 8px;
            border: 1px solid #c8e6c9;
        }
        
        .fixed-amount-info p {
            margin-bottom: 5px;
            font-weight: bold;
            color: #2e7d32;
        }

        /* API状态指示器 */
        .api-status {
            display: none;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            text-align: center;
            font-size: 14px;
        }

        .api-status.retrying {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .api-status.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .api-status.success {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        /* 简化进度指示器 */
        .progress-info {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <header>
        <div class="container">
            <nav class="navbar">
                <div class="logo">润藏命理</div>
                <ul class="nav-links">
                    <li><a href="#home">首页</a></li>
                    <li><a href="#services">服务项目</a></li>
                    <li><a href="#contact">联系我们</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- 首页内容 -->
    <section id="home" class="hero">
        <div class="container">
            <div class="hero-content">
                <h1>探索命运奥秘，洞悉人生轨迹</h1>
                <p>职业命理师团队，基于命理泰斗梁湘润大师论命体系与现代算法，为您揭示人生密码，提供精准运势指导</p>
                <a href="#services" class="btn">立即测算</a>
            </div>
        </div>
    </section>

    <!-- 服务项目 -->
    <section id="services" class="services">
        <div class="container">
            <div class="section-title">
                <h2>专业命理服务</h2>
                <p>选择适合您的咨询服务，开启命运探索之旅</p>
            </div>
            <div class="services-grid">
                <!-- 测试验证服务 -->
                <div class="service-card">
                    <h3>测试验证服务</h3>
                    <div class="price">¥19.9</div>
                    <ul class="service-features">
                        <li>深入分析八字原局喜忌</li>
                        <li>解读性格特点</li>
                        <li>测算之前每步大运吉凶</li>
                        <li>过往关键流年吉凶验证</li>
                    </ul>
                    <a href="javascript:void(0)" class="btn" onclick="selectService('测试验证服务', 19.9)">立即购买</a>
                </div>
                
                <!-- 流年运势分析 -->
                <div class="service-card">
                    <h3>流年运势分析</h3>
                    <div class="price">¥38</div>
                    <ul class="service-features">
                        <li>深入分析八字原局喜忌</li>
                        <li>解读性格特点</li>
                        <li>测算当年及往后5年运势</li>
                        <li>事业财运、婚姻感情等人生大事分析</li>
                    </ul>
                    <a href="javascript:void(0)" class="btn" onclick="selectService('流年运势分析', 38)">立即购买</a>
                </div>
                
                <!-- 人生详批服务 -->
                <div class="service-card">
                    <h3>人生详批服务</h3>
                    <div class="price">¥138</div>
                    <ul class="service-features">
                        <li>深入分析八字原局喜忌</li>
                        <li>解读性格特点</li>
                        <li>人生每步大运吉凶分析</li>
                        <li>人生高低点分析</li>
                        <li>往后关键流年分析</li>
                        <li>重要人生事项提醒</li>
                        <li>风水建议</li>
                    </ul>
                    <a href="javascript:void(0)" class="btn" onclick="selectService('人生详批服务', 138)">立即购买</a>
                </div>
                
                <!-- 婚缘配对分析 -->
                <div class="service-card">
                    <h3>婚缘配对分析</h3>
                    <div class="price">¥52</div>
                    <ul class="service-features">
                        <li>分析与伴侣的八字契合度</li>
                        <li>解读感情发展趋势</li>
                        <li>提供婚姻建议</li>
                    </ul>
                    <a href="javascript:void(0)" class="btn" onclick="selectService('婚缘配对分析', 52)">立即购买</a>
                </div>
            </div>
        </div>
    </section>

    <!-- 信息收集表单 -->
    <section id="info-form" class="info-form" style="display: none;">
        <div class="container">
            <div class="section-title">
                <h2>填写个人信息</h2>
                <p>请提供准确的出生信息，以确保分析结果的准确性</p>
            </div>
            <div class="form-container">
                <form id="user-info-form">
                    <div class="form-group">
                        <label for="service-type" class="required">服务类型</label>
                        <input type="text" id="service-type" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="name" class="required">姓名</label>
                        <input type="text" id="name" required>
                        <div class="error" id="name-error">请输入姓名</div>
                    </div>
                    
                    <div id="single-person-info">
                        <h3>个人出生信息</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="birth-year" class="required">出生年份</label>
                                <input type="number" id="birth-year" min="1900" max="2023" required>
                                <div class="error" id="birth-year-error">请输入有效的出生年份</div>
                            </div>
                            <div class="form-group">
                                <label for="birth-month" class="required">出生月份</label>
                                <select id="birth-month" required>
                                    <option value="">请选择</option>
                                    <option value="1">1月</option>
                                    <option value="2">2月</option>
                                    <option value="3">3月</option>
                                    <option value="4">4月</option>
                                    <option value="5">5月</option>
                                    <option value="6">6月</option>
                                    <option value="7">7月</option>
                                    <option value="8">8月</option>
                                    <option value="9">9月</option>
                                    <option value="10">10月</option>
                                    <option value="11">11月</option>
                                    <option value="12">12月</option>
                                </select>
                                <div class="error" id="birth-month-error">请选择出生月份</div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="birth-day" class="required">出生日期</label>
                                <input type="number" id="birth-day" min="1" max="31" required>
                                <div class="error" id="birth-day-error">请输入有效的出生日期</div>
                            </div>
                            <div class="form-group">
                                <label for="birth-hour" class="required">出生时辰</label>
                                <select id="birth-hour" required>
                                    <option value="">请选择</option>
                                    <!-- 生成0-23时的选项 -->
                                </select>
                                <div class="error" id="birth-hour-error">请选择出生时辰</div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="birth-minute" class="required">出生分钟</label>
                                <select id="birth-minute" required>
                                    <option value="">请选择</option>
                                    <!-- 生成0-59分的选项 -->
                                </select>
                                <div class="error" id="birth-minute-error">请选择出生分钟</div>
                            </div>
                            <div class="form-group">
                                <label for="gender" class="required">性别</label>
                                <select id="gender" required>
                                    <option value="">请选择</option>
                                    <option value="male">男</option>
                                    <option value="female">女</option>
                                </select>
                                <div class="error" id="gender-error">请选择性别</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="partner-info" style="display: none;">
                        <h3>伴侣出生信息</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="partner-name">伴侣姓名</label>
                                <input type="text" id="partner-name">
                            </div>
                            <div class="form-group">
                                <label for="partner-gender">伴侣性别</label>
                                <select id="partner-gender">
                                    <option value="">请选择</option>
                                    <option value="male">男</option>
                                    <option value="female">女</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="partner-birth-year">伴侣出生年份</label>
                                <input type="number" id="partner-birth-year" min="1900" max="2023">
                                <div class="error" id="partner-birth-year-error">请输入有效的伴侣出生年份</div>
                            </div>
                            <div class="form-group">
                                <label for="partner-birth-month">伴侣出生月份</label>
                                <select id="partner-birth-month">
                                    <option value="">请选择</option>
                                    <option value="1">1月</option>
                                    <option value="2">2月</option>
                                    <option value="3">3月</option>
                                    <option value="4">4月</option>
                                    <option value="5">5月</option>
                                    <option value="6">6月</option>
                                    <option value="7">7月</option>
                                    <option value="8">8月</option>
                                    <option value="9">9月</option>
                                    <option value="10">10月</option>
                                    <option value="11">11月</option>
                                    <option value="12">12月</option>
                                </select>
                                <div class="error" id="partner-birth-month-error">请选择伴侣出生月份</div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="partner-birth-day">伴侣出生日期</label>
                                <input type="number" id="partner-birth-day" min="1" max="31">
                                <div class="error" id="partner-birth-day-error">请输入有效的伴侣出生日期</div>
                            </div>
                            <div class="form-group">
                                <label for="partner-birth-hour">伴侣出生时辰</label>
                                <select id="partner-birth-hour">
                                    <option value="">请选择</option>
                                    <!-- 生成0-23时的选项 -->
                                </select>
                                <div class="error" id="partner-birth-hour-error">请选择伴侣出生时辰</div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="partner-birth-minute">伴侣出生分钟</label>
                                <select id="partner-birth-minute">
                                    <option value="">请选择</option>
                                    <!-- 生成0-59分的选项 -->
                                </select>
                                <div class="error" id="partner-birth-minute-error">请选择伴侣出生分钟</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="specific-request">具体求测事项（可选）</label>
                        <textarea id="specific-request" rows="4"></textarea>
                    </div>
                    
                    <h3>选择支付方式</h3>
                    <div class="payment-options">
                        <div class="payment-option" id="wechat-pay" onclick="selectPayment('wechat')">
                            <div class="payment-icon">
                                <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDI0IDEwMjQiIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCI+PHBhdGggZmlsbD0iIzA3QzE2MCIgZD0iTTUxMiA2NEMyNjQuNiA2NCA2NCAyNjQuNiA2NCA1MTJzMjAwLjYgNDQ4IDQ0OCA0NDggNDQ4LTIwMC42IDQ0OC00NDhTNzU5LjQgNjQgNTEyIDY0em0yNzQuNiA0MTUuNGMtMTUuOS0yNi4yLTM3LjEtNDYuOC02MS45LTYwLjQtMjcuNi0xNS4yLTU5LjgtMjMuMy05My4zLTIzLjMtMzMuNSAwLTY1LjcgOC4xLTkzLjMgMjMuMy0yNC44IDEzLjYtNDYgMzQuMi02MS45IDYwLjQtMTUuOSAyNi4yLTI0LjMgNTYuMi0yNC4zIDg2LjcgMCAzMC41IDguNCA2MC41IDI0LjMgODYuNyAxNS45IDI2LjIgMzcuMSA0Ni44IDYxLjkgNjAuNCAyNy42IDE1LjIgNTkuOCAyMy4zIDkzLjMgMjMuMyAzMy41IDAgNjUuNy04LjEgOTMuMy0yMy4zIDI0LjgtMTMuNiA0Ni0zNC4yIDYxLjktNjAuNCAxNS45LTI2LjIgMjQuMy01Ni4yIDI0LjMtODYuNyAwLTMwLjUtOC40LTYwLjUtMjQuMy04Ni43eiIvPjxwYXRoIGZpbGw9IiNGRkYiIGQ9Ik0zOTUuOCA1MjcuMmMtMzAuOSAwLTU2LTI1LjEtNTYtNTZzMjUuMS01NiA1Ni01NiA1NiAyNS4xIDU2IDU2LTI1LjEgNTYtNTYgNTZ6bTIzMi40IDBjLTMwLjkgMC01Ni0yNS4xLTU2LTU2czI1LjEtNTYgNTYtNTYgNTYgMjUuMSA1NiA1Ni0yNS4xIDU2LTU2IDU2eiIvPjwvc3ZnPg==" alt="微信支付">
                            </div>
                            <div>微信支付</div>
                        </div>
                        <div class="payment-option" id="alipay" onclick="selectPayment('alipay')">
                            <div class="payment-icon">
                                <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDI0IDEwMjQiIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCI+PHBhdGggZmlsbD0iIzAwOTZFQyIgZD0iTTUxMiA2NEMyNjQuNiA2NCA2NCAyNjQuNiA2NCA1MTJzMjAwLjYgNDQ4IDQ0OCA0NDggNDQ4LTIwMC42IDQ0OC00NDhTNzU5LjQgNjQgNTEyIDY0em0yNzQuNiA0MTUuNGMtMTUuOS0yNi4yLTM3LjUtNDYuOC02MS45LTYwLjQtMjcuNi0xNS4yLTU5LjgtMjMuMy05My4zLTIzLjMtMzMuNSAwLTY1LjcgOC4xLTkzLjMgMjMuMy0yNC44IDEzLjYtNDYgMzMuMi02MS45IDYwLjQtMTUuOSAyNi4yLTI0LjMgNTYuMi0yNC4zIDg2LjcgMCAzMC41IDguNCA2MC41IDI0LjMgODYuNyAxNS45IDI2LjIgMzcuMSA0Ni44IDYxLjkgNjAuNCAyNy42IDE1LjIgNTkuOCAyMy4zIDkzLjMgMjMuMyAzMy41IDAgNjUuNy04LjEgOTMuMy0yMy4zIDI0LjgtMTMuNiA0Ni0zNC4yIDYxLjktNjAuNCAxNS45LTI2LjIgMjQuMy01Ni4yIDI0LjMtODYuNyAwLTMwLjUtOC40LTYwLjUtMjQuMy04Ni43eiIvPjxwYXRoIGZpbGw9IiNGRkYiIGQ9Ik00MjAuOSA0MTUuNGMtMzAuOSAwLTU2LTI1LjEtNTYtNTZzMjUuMS01NiA1Ni01NiA1NiAyNS4xIDU2IDU2LTI1LjEgNTYtNTYgNTZ6bTE4Mi4yIDBjLTMwLjkgMC01Ni0yNS4xLTU2LTU2czI1LjEtNTYgNTYtNTYgNTYgMjUuMSA1NiA1Ni0yNS4xIDU2LTU2IDU2eiIvPjwvc3ZnPg==" alt="支付宝">
                            </div>
                            <div>支付宝</div>
                        </div>
                    </div>
                    <div class="error" id="payment-error" style="margin-top: 10px;">请选择支付方式</div>
                    
                    <div class="form-group" style="margin-top: 30px; display: flex; gap: 10px;">
                        <button type="button" class="btn" id="submit-btn" onclick="submitForm()">立即支付</button>
                        <button type="button" class="btn" style="background-color: #6c757d;" onclick="resetForm()">重新选择服务</button>
                    </div>
                </form>
            </div>
        </div>
    </section>

    <!-- 支付弹窗 -->
    <div id="payment-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>支付订单</h3>
                <span class="close" onclick="closePaymentModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="order-info">
                    <p><strong>服务类型:</strong> <span id="payment-service-type"></span></p>
                    <p><strong>订单金额:</strong> <span id="payment-amount"></span></p>
                    <p><strong>订单号:</strong> <span id="payment-order-id"></span></p>
                </div>
                
                <div class="fixed-amount-info">
                    <p>✅ 此二维码为固定金额支付码，扫码后无需输入金额</p>
                    </div>
                
                <div class="qr-codes">
                    <div class="qr-code" id="wechat-qr-container">
                        <img id="wechat-qr" src="https://via.placeholder.com/260x260?text=微信固定金额收款码" alt="微信固定金额收款码">
                        <p>微信支付</p>
                    </div>
                    <div class="qr-code" id="alipay-qr-container">
                        <img id="alipay-qr" src="https://via.placeholder.com/260x260?text=支付宝固定金额收款码" alt="支付宝固定金额收款码">
                        <p>支付宝</p>
                    </div>
                </div>
                
                <div class="payment-status">
                    <p id="payment-status-text">请使用微信/支付宝扫描上方二维码完成支付</p>
                </div>
                
                <div class="payment-actions">
                    <button class="btn" onclick="confirmPayment()">我已支付</button>
                    <button class="btn" style="background-color: #6c757d;" onclick="closePaymentModal()">取消支付</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 分析过程 - 优化后的简化版本 -->
    <section id="analysis-process-section" class="analysis-process" style="display: none;">
        <div class="container">
            <div class="spinner"></div>
            <h3>润藏命理团队正在为您分析</h3>
            <p>基于您的出生信息和求测事项，我们的专业命理师团队正在深入分析，分析时间大约2-3分钟，请耐心等待...</p>
            
            <div class="api-status" id="api-status"></div>
            
            <div class="progress-info">
                <p>当前进度: <span id="progress-text">正在初始化分析引擎...</span></p>
            </div>
            
            <div class="analysis-steps">
                <div class="analysis-step" id="step1">
                    <span class="step-icon">1</span>
                    <strong>数据解析与八字排盘</strong>
                </div>
                <div class="analysis-step" id="step2">
                    <span class="step-icon">2</span>
                    <strong>命理分析与深度计算</strong>
                </div>
                <div class="analysis-step" id="step3">
                    <span class="step-icon">3</span>
                    <strong>报告生成与优化</strong>
                </div>
            </div>
            
            <div class="analysis-result" id="analysis-result">
                <div id="result-content" class="analysis-result-content"></div>
                <div class="word-count">报告字数: <span id="word-count">0</span> 字</div>
                <div class="result-actions">
                    <button class="btn" onclick="copyResult()">复制结果</button>
                    <button class="btn" onclick="downloadResult()">下载报告</button>
                    <button class="btn" onclick="downloadPDF()">下载PDF</button>
                    <button class="btn" style="background-color: #6c757d;" onclick="goToHome()">返回首页</button>
                </div>
            </div>
        </div>
    </section>

    <!-- 成功消息 -->
    <section id="success-section" class="success-message" style="display: none;">
        <div class="success-icon">✓</div>
        <h2>支付成功！</h2>
        <p>您的订单已提交成功，润藏命理团队正在为您分析</p>
        <p>分析结果将在下方展示</p>
        <p>订单号: <span id="order-id"></span></p>
        <div style="margin-top: 30px;">
            <button class="btn" onclick="goToHome()">返回首页</button>
        </div>
    </section>

    <!-- 页脚 -->
    <footer id="contact">
        <div class="container">
            <div class="footer-content">
                <div class="footer-column">
                    <h3>润藏命理</h3>
                    <p>专业命理师团队分析平台，结合传统智慧与现代技术，为您提供精准的命运解读和人生指导。</p>
                </div>
                <div class="footer-column">
                    <h3>服务项目</h3>
                    <ul class="footer-links">
                        <li><a href="#services">测试验证服务</a></li>
                        <li><a href="#services">流年运势分析</a></li>
                        <li><a href="#services">人生详批服务</a></li>
                        <li><a href="#services">婚缘配对分析</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>联系我们</h3>
                    <ul class="footer-links">
                        <li>客服微信: runzang888</li>
                        <li>客服电话: 400-800-1389</li>
                        <li>服务时间: 9:00-17:00</li>
                    </ul>
                </div>
            </div>
            <div class="copyright">
                <p>&copy; 2023 润藏命理咨询平台 版权所有</p>
            </div>
        </div>
    </footer>

    <!-- 引入html2pdf库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        // DeepSeek API密钥
        const DEEPSEEK_API_KEY = 'sk-0c763bf4e169413dbd57a45e8ca73a6a';
        const DEEPSEEK_API_URL = 'https://api.deepseek.com/v1/chat/completions';
        
        // 固定金额收款码配置
        const FIXED_AMOUNT_QR_CODES = {
            '测试验证服务': {
                wechat: 'images/wechat-pay-19.9.jpg',
                alipay: 'images/alipay-19.9.jpg'
            },
            '流年运势分析': {
                wechat: 'images/wechat-pay-38.jpg',
                alipay: 'images/alipay-38.jpg'
            },
            '人生详批服务': {
                wechat: 'images/wechat-pay-138.jpg',
                alipay: 'images/alipay-138.jpg'
            },
            '婚缘配对分析': {
                wechat: 'images/wechat-pay-52.jpg',
                alipay: 'images/alipay-52.jpg'
            }
        };
        
        // 当前选择的支付信息
        let currentPaymentInfo = null;
        let currentUserData = null;
        let currentPaymentMethod = null;
        
        // 命理分析提示词模板
        const PROMPT_TEMPLATES = {
            '测试验证服务': `你是一位职业命理大师，请根据以下信息进项八字分析，用余氏用神、沈氏格局、六十甲子日时断法则综合分析命局层次，用十神定位解读性格特点，用沈氏大运、金不换大运、刑冲合会法则综合分析大运吉凶，用喜忌用神、刑冲合会综合分析流年吉凶：

用户信息：
姓名：{name}
性别：{gender}
出生时间：{birthYear}年{birthMonth}月{birthDay}日{birthHour}时{birthMinute}分

请进行以下分析：
1. 分析八字原局喜忌
2. 解读性格特点
3. 测算之前每步大运吉凶
4. 过往关键流年吉凶验证
5. 提供专业建议

请用专业、详细但易懂的语言回复。回复中不要使用任何markdown符号如#、*、-等，请使用纯文本格式。`,

            '流年运势分析': `你是一位职业命理大师，请根据以下信息进项八字分析，用余氏用神、沈氏格局、六十甲子日时断法则综合分析命局层次，用十神定位解读性格特点，用沈氏大运、金不换大运、刑冲合会法则综合分析大运吉凶，用喜忌用神、刑冲合会综合分析流年吉凶：

用户信息：
姓名：{name}
性别：{gender}
出生时间：{birthYear}年{birthMonth}月{birthDay}日{birthHour}时{birthMinute}分
具体求测事项：{specificRequest}

请进行以下分析：
1. 分析八字原局喜忌
2. 解读性格特点
3. 测算当年及往后5年运势
4. 事业财运、婚姻感情等人生大事分析
5. 提供年度建议和注意事项

请用专业、详细但易懂的语言回复。回复中不要使用任何markdown符号如#、*、-等，请使用纯文本格式。`,

            '人生详批服务': `你是一位职业命理大师，请根据以下信息进项八字分析，用余氏用神、沈氏格局、六十甲子日时断法则综合分析命局层次，用十神定位解读性格特点，用沈氏大运、金不换大运、刑冲合会法则综合分析大运吉凶，用喜忌用神、刑冲合会综合分析流年吉凶：
用户信息：
姓名：{name}
性别：{gender}
出生时间：{birthYear}年{birthMonth}月{birthDay}日{birthHour}时{birthMinute}分
具体求测事项：{specificRequest}

请进行以下全面分析：
1. 深入分析八字原局喜忌
2. 详细解读性格特点
3. 人生每步大运吉凶分析
4. 人生高低点分析
5. 往后关键流年分析
6. 重要人生事项提醒
7. 风水建议和个人发展建议

请用专业、详尽但易懂的语言回复。回复中不要使用任何markdown符号如#、*、-等，请使用纯文本格式。`,

            '婚缘配对分析': `你是一位职业的命理大师，请根据以下信息进行八字分析：

用户信息：
姓名：{name}
性别：{gender}
出生时间：{birthYear}年{birthMonth}月{birthDay}日{birthHour}时{birthMinute}分

伴侣信息：
姓名：{partnerName}
性别：{partnerGender}
出生时间：{partnerBirthYear}年{partnerBirthMonth}月{partnerBirthDay}日{partnerBirthHour}时{partnerBirthMinute}分

具体求测事项：{specificRequest}

请进行以下分析：
1. 分析双方的八字契合度
2. 解读感情发展趋势
3. 婚姻稳定性分析
4. 双方性格匹配度
5. 提供婚姻建议和注意事项

请用专业、详细但易懂的语言回复。回复中不要使用任何markdown符号如#、*、-等，请使用纯文本格式。`
        };
        
        // 生成小时和分钟选项
        function generateTimeOptions() {
            const hourSelect = document.getElementById('birth-hour');
            const minuteSelect = document.getElementById('birth-minute');
            const partnerHourSelect = document.getElementById('partner-birth-hour');
            const partnerMinuteSelect = document.getElementById('partner-birth-minute');
            
            // 生成小时选项 (0-23)
            for (let i = 0; i < 24; i++) {
                const hour = i < 10 ? '0' + i : i;
                const option = document.createElement('option');
                option.value = i;
                option.textContent = hour + '时';
                hourSelect.appendChild(option);
                
                const partnerOption = option.cloneNode(true);
                partnerHourSelect.appendChild(partnerOption);
            }
            
            // 生成分钟选项 (0-59)
            for (let i = 0; i < 60; i++) {
                const minute = i < 10 ? '0' + i : i;
                const option = document.createElement('option');
                option.value = i;
                option.textContent = minute + '分';
                minuteSelect.appendChild(option);
                
                const partnerOption = option.cloneNode(true);
                partnerMinuteSelect.appendChild(partnerOption);
            }
        }
        
        // 选择服务
        function selectService(serviceName, price) {
            document.getElementById('service-type').value = serviceName + ' - ¥' + price;
            
            // 显示/隐藏伴侣信息区域
            if (serviceName === '婚缘配对分析') {
                document.getElementById('partner-info').style.display = 'block';
            } else {
                document.getElementById('partner-info').style.display = 'none';
            }
            
            // 滚动到表单区域
            document.getElementById('info-form').style.display = 'block';
            document.getElementById('info-form').scrollIntoView({ behavior: 'smooth' });
            
            // 重置表单错误状态
            resetErrors();
        }
        
        // 选择支付方式
        function selectPayment(type) {
            document.querySelectorAll('.payment-option').forEach(option => {
                option.classList.remove('active');
            });
            
            if (type === 'wechat') {
                document.getElementById('wechat-pay').classList.add('active');
            } else if (type === 'alipay') {
                document.getElementById('alipay').classList.add('active');
            }
            
            currentPaymentMethod = type;
            
            // 隐藏支付错误
            document.getElementById('payment-error').style.display = 'none';
        }
        
        // 重置表单
        function resetForm() {
            document.getElementById('info-form').style.display = 'none';
            document.getElementById('user-info-form').reset();
            resetErrors();
            document.querySelectorAll('.payment-option').forEach(option => {
                option.classList.remove('active');
            });
            
            currentPaymentMethod = null;
            
            // 滚动到服务区域
            document.getElementById('services').scrollIntoView({ behavior: 'smooth' });
        }
        
        // 重置错误状态
        function resetErrors() {
            document.querySelectorAll('.error').forEach(error => {
                error.style.display = 'none';
            });
        }
        
        // 验证表单
        function validateForm() {
            let isValid = true;
            resetErrors();
            
            // 验证姓名
            const name = document.getElementById('name').value;
            if (!name.trim()) {
                document.getElementById('name-error').style.display = 'block';
                isValid = false;
            }
            
            // 验证出生年份
            const birthYear = document.getElementById('birth-year').value;
            if (!birthYear || birthYear < 1900 || birthYear > 2023) {
                document.getElementById('birth-year-error').style.display = 'block';
                isValid = false;
            }
            
            // 验证出生月份
            const birthMonth = document.getElementById('birth-month').value;
            if (!birthMonth) {
                document.getElementById('birth-month-error').style.display = 'block';
                isValid = false;
            }
            
            // 验证出生日期
            const birthDay = document.getElementById('birth-day').value;
            if (!birthDay || birthDay < 1 || birthDay > 31) {
                document.getElementById('birth-day-error').style.display = 'block';
                isValid = false;
            } else {
                // 验证日期有效性（简单版本）
                const year = parseInt(birthYear);
                const month = parseInt(birthMonth);
                const day = parseInt(birthDay);
                
                if (month === 2 && day > 29) {
                    document.getElementById('birth-day-error').textContent = '2月最多29天';
                    document.getElementById('birth-day-error').style.display = 'block';
                    isValid = false;
                } else if ([4, 6, 9, 11].includes(month) && day > 30) {
                    document.getElementById('birth-day-error').textContent = '该月份最多30天';
                    document.getElementById('birth-day-error').style.display = 'block';
                    isValid = false;
                }
            }
            
            // 验证出生时辰
            const birthHour = document.getElementById('birth-hour').value;
            if (!birthHour) {
                document.getElementById('birth-hour-error').style.display = 'block';
                isValid = false;
            }
            
            // 验证出生分钟
            const birthMinute = document.getElementById('birth-minute').value;
            if (!birthMinute) {
                document.getElementById('birth-minute-error').style.display = 'block';
                isValid = false;
            }
            
            // 验证性别
            const gender = document.getElementById('gender').value;
            if (!gender) {
                document.getElementById('gender-error').style.display = 'block';
                isValid = false;
            }
            
            // 如果是婚缘配对分析，验证伴侣信息
            const serviceType = document.getElementById('service-type').value;
            if (serviceType.includes('婚缘配对分析')) {
                const partnerBirthYear = document.getElementById('partner-birth-year').value;
                if (!partnerBirthYear || partnerBirthYear < 1900 || partnerBirthYear > 2023) {
                    document.getElementById('partner-birth-year-error').style.display = 'block';
                    isValid = false;
                }
                
                const partnerBirthMonth = document.getElementById('partner-birth-month').value;
                if (!partnerBirthMonth) {
                    document.getElementById('partner-birth-month-error').style.display = 'block';
                    isValid = false;
                }
                
                const partnerBirthDay = document.getElementById('partner-birth-day').value;
                if (!partnerBirthDay || partnerBirthDay < 1 || partnerBirthDay > 31) {
                    document.getElementById('partner-birth-day-error').style.display = 'block';
                    isValid = false;
                }
                
                const partnerBirthHour = document.getElementById('partner-birth-hour').value;
                if (!partnerBirthHour) {
                    document.getElementById('partner-birth-hour-error').style.display = 'block';
                    isValid = false;
                }
                
                const partnerBirthMinute = document.getElementById('partner-birth-minute').value;
                if (!partnerBirthMinute) {
                    document.getElementById('partner-birth-minute-error').style.display = 'block';
                    isValid = false;
                }
            }
            
            // 验证支付方式
            if (!currentPaymentMethod) {
                document.getElementById('payment-error').style.display = 'block';
                isValid = false;
            }
            
            return isValid;
        }
        
        // 提交表单
        function submitForm() {
            if (!validateForm()) {
                return;
            }
            
            // 获取服务信息
            const serviceType = document.getElementById('service-type').value;
            const serviceName = serviceType.split(' - ')[0];
            const price = parseFloat(serviceType.split('¥')[1]);
            
            // 生成订单ID
            const orderId = 'RZ' + Date.now() + Math.floor(Math.random() * 1000);
            
            // 保存当前支付信息
            currentPaymentInfo = {
                serviceName: serviceName,
                price: price,
                orderId: orderId
            };
            
            // 收集用户数据
            currentUserData = collectUserData();
            
            // 显示支付弹窗
            document.getElementById('payment-service-type').textContent = serviceName;
            document.getElementById('payment-amount').textContent = '¥' + price;
            document.getElementById('payment-order-id').textContent = orderId;
            
            // 根据支付方式更新支付弹窗内容
            updatePaymentModalContent();
            
            // 禁用背景滚动
            document.body.style.overflow = 'hidden';
            
            document.getElementById('payment-modal').style.display = 'block';
        }
        
        // 更新支付弹窗内容
        function updatePaymentModalContent() {
            const wechatQRContainer = document.getElementById('wechat-qr-container');
            const alipayQRContainer = document.getElementById('alipay-qr-container');
            const statusText = document.getElementById('payment-status-text');
            const orderId = document.getElementById('payment-order-id').textContent;
            const serviceName = currentPaymentInfo.serviceName;
            
            // 根据支付方式显示对应的二维码
            if (currentPaymentMethod === 'wechat') {
                wechatQRContainer.style.display = 'block';
                alipayQRContainer.style.display = 'none';
                
                // 设置固定金额微信收款码
                document.getElementById('wechat-qr').src = FIXED_AMOUNT_QR_CODES[serviceName].wechat;
                
                statusText.innerHTML = `请使用微信扫描上方二维码完成支付<br>
                                        支付完成后请点击"我已支付"按钮`;
            } else if (currentPaymentMethod === 'alipay') {
                wechatQRContainer.style.display = 'none';
                alipayQRContainer.style.display = 'block';
                
                // 设置固定金额支付宝收款码
                document.getElementById('alipay-qr').src = FIXED_AMOUNT_QR_CODES[serviceName].alipay;
                
                statusText.innerHTML = `请使用支付宝扫描上方二维码完成支付<br>
                                        支付完成后请点击"我已支付"按钮`;
            }
        }
        
        // 关闭支付弹窗
        function closePaymentModal() {
            document.getElementById('payment-modal').style.display = 'none';
            // 恢复背景滚动
            document.body.style.overflow = 'auto';
        }
        
        // 确认支付
        function confirmPayment() {
            const orderId = document.getElementById('payment-order-id').textContent;
            const confirmed = confirm(`请确认您已完成支付，如未支付完成，我们将无法为您提供服务。\n\n确认已支付?`);
            
            if (confirmed) {
                // 关闭支付弹窗
                closePaymentModal();
                
                // 显示成功消息
                document.getElementById('success-section').style.display = 'block';
                document.getElementById('order-id').textContent = currentPaymentInfo.orderId;
                document.getElementById('success-section').scrollIntoView({ behavior: 'smooth' });
                
                // 隐藏表单
                document.getElementById('info-form').style.display = 'none';
                
                // 开始分析
                setTimeout(() => {
                    startAnalysis();
                }, 2000);
            }
        }
        
        // 开始分析
        async function startAnalysis() {
            // 隐藏成功消息，显示分析过程
            document.getElementById('success-section').style.display = 'none';
            document.getElementById('analysis-process-section').style.display = 'block';
            document.getElementById('analysis-process-section').scrollIntoView({ behavior: 'smooth' });
            
            // 更新分析步骤
            updateAnalysisStep(1);
            
            try {
                // 调用DeepSeek API进行命理分析
                const analysisResult = await callDeepSeekAPIWithRetry(currentUserData);
                
                // 显示分析结果
                displayAnalysisResult(analysisResult);
                
            } catch (error) {
                console.error('分析失败:', error);
                document.getElementById('result-content').textContent = '分析失败，请稍后重试或联系客服。错误信息: ' + error.message;
                document.getElementById('analysis-result').style.display = 'block';
            }
        }
        
        // 收集用户数据
        function collectUserData() {
            const serviceType = document.getElementById('service-type').value;
            const name = document.getElementById('name').value;
            const birthYear = document.getElementById('birth-year').value;
            const birthMonth = document.getElementById('birth-month').value;
            const birthDay = document.getElementById('birth-day').value;
            const birthHour = document.getElementById('birth-hour').value;
            const birthMinute = document.getElementById('birth-minute').value;
            const gender = document.getElementById('gender').value;
            const specificRequest = document.getElementById('specific-request').value;
            
            // 提取服务名称（去掉价格部分）
            const serviceName = serviceType.split(' - ')[0];
            
            let partnerData = null;
            if (serviceName === '婚缘配对分析') {
                partnerData = {
                    name: document.getElementById('partner-name').value,
                    gender: document.getElementById('partner-gender').value,
                    birthYear: document.getElementById('partner-birth-year').value,
                    birthMonth: document.getElementById('partner-birth-month').value,
                    birthDay: document.getElementById('partner-birth-day').value,
                    birthHour: document.getElementById('partner-birth-hour').value,
                    birthMinute: document.getElementById('partner-birth-minute').value
                };
            }
            
            return {
                serviceType: serviceName,
                name,
                birthYear,
                birthMonth,
                birthDay,
                birthHour,
                birthMinute,
                gender,
                specificRequest,
                partnerData
            };
        }
        
        // 更新分析步骤 - 优化后的简化版本
        function updateAnalysisStep(step) {
            // 更新进度文本
            const progressTexts = [
                "正在初始化分析引擎...",
                "正在进行八字排盘和数据解析...", 
                "正在进行深度命理分析...",
                "正在生成最终报告..."
            ];
            document.getElementById('progress-text').textContent = progressTexts[step-1] || "分析进行中...";
            
            // 重置所有步骤
            for (let i = 1; i <= 3; i++) {
                const stepElement = document.getElementById('step' + i);
                stepElement.classList.remove('completed', 'active');
            }
            
            // 设置已完成步骤
            for (let i = 1; i < step; i++) {
                const stepElement = document.getElementById('step' + i);
                stepElement.classList.add('completed');
            }
            
            // 设置当前步骤
            if (step <= 3) {
                const currentStep = document.getElementById('step' + step);
                currentStep.classList.add('active');
            }
            
            // 模拟步骤进度
            if (step < 3) {
                setTimeout(() => {
                    updateAnalysisStep(step + 1);
                }, 2000);
            }
        }
        
        // 带重试机制的DeepSeek API调用
        async function callDeepSeekAPIWithRetry(userData, retryCount = 0) {
            const maxRetries = 5; // 增加重试次数
            const baseDelay = 2000; // 基础延迟2秒
            
            try {
                showAPIStatus('retrying', `正在进行分析... (尝试 ${retryCount + 1}/${maxRetries + 1})`);
                
                const result = await callDeepSeekAPI(userData);
                
                // 检查内容完整性
                if (isContentComplete(result, userData.serviceType)) {
                    showAPIStatus('success', '分析完成！');
                    return result;
                } else {
                    throw new Error('API返回内容不完整');
                }
                
            } catch (error) {
                console.error(`API调用失败 (尝试 ${retryCount + 1}/${maxRetries + 1}):`, error);
                
                if (retryCount < maxRetries) {
                    const delay = baseDelay * Math.pow(2, retryCount); // 指数退避
                    showAPIStatus('retrying', `分析遇到问题，${delay/1000}秒后重试... (${retryCount + 1}/${maxRetries})`);
                    
                    // 等待一段时间后重试
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return callDeepSeekAPIWithRetry(userData, retryCount + 1);
                } else {
                    showAPIStatus('error', '分析失败，使用备用方案生成报告');
                    return getMockAnalysisResult(userData);
                }
            }
        }
        
        // 显示API状态
        function showAPIStatus(type, message) {
            const statusElement = document.getElementById('api-status');
            statusElement.textContent = message;
            statusElement.className = 'api-status ' + type;
            statusElement.style.display = 'block';
        }
        
        // 检查内容完整性
        function isContentComplete(content, serviceType) {
            if (!content || content.length < 800) { // 提高最小字数要求
                console.warn('内容长度不足:', content?.length);
                return false;
            }
            
            // 检查是否包含关键部分
            const requiredSections = {
                '测试验证服务': ['八字', '性格', '大运', '流年', '建议'],
                '流年运势分析': ['八字', '性格', '运势', '建议', '分析'],
                '人生详批服务': ['八字', '性格', '大运', '流年', '建议', '分析'],
                '婚缘配对分析': ['八字', '感情', '婚姻', '建议', '分析']
            };
            
            const sections = requiredSections[serviceType] || [];
            const hasRequiredSections = sections.every(section => content.includes(section));
            
            if (!hasRequiredSections) {
                console.warn('缺少必要段落:', sections.filter(s => !content.includes(s)));
            }
            
            return hasRequiredSections;
        }
        
        // 清理报告内容 - 移除markdown符号并优化格式
        function cleanReportContent(content) {
            if (!content) return '';
            
            // 移除markdown符号
            let cleaned = content
                .replace(/#{1,6}\s?/g, '') // 移除标题符号
                .replace(/\*\*(.*?)\*\*/g, '$1') // 移除粗体
                .replace(/\*(.*?)\*/g, '$1') // 移除斜体
                .replace(/~~(.*?)~~/g, '$1') // 移除删除线
                .replace(/`(.*?)`/g, '$1') // 移除行内代码
                .replace(/```[\s\S]*?```/g, '') // 移除代码块
                .replace(/\[(.*?)\]\(.*?\)/g, '$1') // 移除链接
                .replace(/^-\s/gm, '• ') // 将-列表项转换为•
                .replace(/^\d+\.\s/gm, ''); // 移除数字列表
            
            // 优化段落格式
            cleaned = cleaned
                .replace(/\n{3,}/g, '\n\n') // 将多个空行减少为两个
                .replace(/^\s+|\s+$/g, ''); // 移除首尾空白
            
            return cleaned;
        }
        
        // 格式化报告内容为HTML
        function formatReportToHTML(content) {
            if (!content) return '';
            
            let html = content;
            
            // 将段落转换为p标签
            html = html.replace(/([^\n])\n([^\n])/g, '$1 $2'); // 合并单行断行
            html = html.split(/\n\n+/).map(paragraph => {
                if (paragraph.trim()) {
                    return `<p>${paragraph.trim()}</p>`;
                }
                return '';
            }).join('');
            
            // 处理标题（通过识别关键词语）
            const titlePatterns = [
                { pattern: /(一、|二、|三、|四、|五、|六、|七、|八、|九、|十、)([^<]+)/g, replacement: '<h3>$1$2</h3>' },
                { pattern: /(【[^】]+】)/g, replacement: '<h3>$1</h3>' },
                { pattern: /(第[一二三四五六七八九十]+部分[：:])/g, replacement: '<h3>$1</h3>' }
            ];
            
            titlePatterns.forEach(({ pattern, replacement }) => {
                html = html.replace(pattern, replacement);
            });
            
            // 处理列表项
            html = html.replace(/•\s([^<]+)/g, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>');
            
            return html;
        }
        
        // 调用DeepSeek API - 修复API调用参数
        async function callDeepSeekAPI(userData) {
            // 构建提示词
            let prompt = PROMPT_TEMPLATES[userData.serviceType];
            
            // 替换占位符
            prompt = prompt.replace(/{name}/g, userData.name)
                          .replace(/{gender}/g, userData.gender === 'male' ? '男' : '女')
                          .replace(/{birthYear}/g, userData.birthYear)
                          .replace(/{birthMonth}/g, userData.birthMonth)
                          .replace(/{birthDay}/g, userData.birthDay)
                          .replace(/{birthHour}/g, userData.birthHour)
                          .replace(/{birthMinute}/g, userData.birthMinute)
                          .replace(/{specificRequest}/g, userData.specificRequest || '无');
            
            // 如果是婚缘配对分析，替换伴侣信息
            if (userData.serviceType === '婚缘配对分析' && userData.partnerData) {
                prompt = prompt.replace(/{partnerName}/g, userData.partnerData.name || '未提供')
                              .replace(/{partnerGender}/g, userData.partnerData.gender === 'male' ? '男' : '女')
                              .replace(/{partnerBirthYear}/g, userData.partnerData.birthYear || '未提供')
                              .replace(/{partnerBirthMonth}/g, userData.partnerData.birthMonth || '未提供')
                              .replace(/{partnerBirthDay}/g, userData.partnerData.birthDay || '未提供')
                              .replace(/{partnerBirthHour}/g, userData.partnerData.birthHour || '未提供')
                              .replace(/{partnerBirthMinute}/g, userData.partnerData.birthMinute || '未提供');
            }
            
            try {
                const response = await fetch(DEEPSEEK_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${DEEPSEEK_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'deepseek-reasoner', // 使用正确的模型名称
                        messages: [
                            {
                                role: 'system',
                                content: '你是一位职业的命理大师，请根据以下信息进项八字分析，用余氏用神、沈氏格局、六十甲子日时断法则综合分析命局层次，用十神定位解读性格特点，用沈氏大运、金不换大运、刑冲合会法则综合分析大运吉凶，用喜忌用神、刑冲合会综合分析流年吉凶。回复中不要使用任何markdown符号，使用纯文本格式。'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        max_tokens: 4000,
                        temperature: 0.7,
                        stream: false
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API请求失败: ${response.status} ${response.statusText} - ${errorText}`);
                }
                
                const data = await response.json();
                
                if (data.choices && data.choices.length > 0 && data.choices[0].message) {
                    return data.choices[0].message.content;
                } else {
                    console.error('API返回数据格式异常:', data);
                    throw new Error('API返回数据格式错误');
                }
                
            } catch (error) {
                console.error('DeepSeek API调用失败:', error);
                throw error;
            }
        }
        
        // 获取模拟分析结果（备用）
        function getMockAnalysisResult(userData) {
            return `【润藏命理分析报告 - ${userData.serviceType}】

尊敬的${userData.name}，您好！

根据您提供的出生信息（${userData.birthYear}年${userData.birthMonth}月${userData.birthDay}日${userData.birthHour}时${userData.birthMinute}分），润藏命理团队为您进行了深入的八字分析。

一、八字原局分析
您的八字为：[八字排盘结果]
日主为[日主]，生于[月令]月，整体格局为[格局类型]。

五行喜忌：
喜神：[喜神]
用神：[用神]
忌神：[忌神]

二、性格特点
您具有[性格特点1]、[性格特点2]的特质，为人[性格描述]。在人际交往中[社交特点]，在事业上[事业倾向]。

三、运势分析
[根据具体服务类型提供相应的运势分析]

四、专业建议
基于您的命局特点，建议您：
• [建议1]
• [建议2]
• [建议3]

以上分析由润藏命理团队专业命理师完成，仅供参考。`;
        }
        
        // 显示分析结果
        function displayAnalysisResult(result) {
            // 清理和格式化结果
            const cleanedResult = cleanReportContent(result);
            const formattedHTML = formatReportToHTML(cleanedResult);
            
            // 创建完整的报告HTML
            const reportHTML = `
                <div class="report-header">
                    <h2>润藏命理分析报告</h2>
                    <div class="report-meta">
                        <p>服务类型：${currentUserData.serviceType}</p>
                        <p>姓名：${currentUserData.name}</p>
                        <p>订单号：${currentPaymentInfo.orderId}</p>
                        <p>分析时间：${new Date().toLocaleString('zh-CN')}</p>
                    </div>
                </div>
                <div class="analysis-sections">
                    ${formattedHTML}
                </div>
            `;
            
            // 显示分析结果区域
            const resultElement = document.getElementById('analysis-result');
            resultElement.style.display = 'block';
            
            // 将格式化后的HTML显示在结果区域
            document.getElementById('result-content').innerHTML = reportHTML;
            
            // 计算字数
            const wordCount = cleanedResult.replace(/\s/g, '').length;
            document.getElementById('word-count').textContent = wordCount;
            
            // 隐藏加载动画
            document.querySelector('.spinner').style.display = 'none';
            
            // 隐藏API状态
            document.getElementById('api-status').style.display = 'none';
            
            // 滚动到结果区域
            resultElement.scrollIntoView({ behavior: 'smooth' });
        }
        
        // 复制结果到剪贴板
        function copyResult() {
            const resultText = document.getElementById('result-content').textContent;
            navigator.clipboard.writeText(resultText).then(() => {
                alert('分析结果已复制到剪贴板');
            }).catch(err => {
                console.error('复制失败:', err);
                alert('复制失败，请手动选择文本复制');
            });
        }
        
        // 下载分析报告为文本文件
        function downloadResult() {
            const resultText = document.getElementById('result-content').textContent;
            const serviceType = currentPaymentInfo.serviceName;
            const name = currentUserData.name;
            const orderId = currentPaymentInfo.orderId;
            
            // 创建格式化的文本内容
            const formattedText = `润藏命理分析报告

服务类型：${serviceType}
姓名：${name}
订单号：${orderId}
分析时间：${new Date().toLocaleString('zh-CN')}

${'='.repeat(50)}

${resultText}

${'='.repeat(50)}
润藏命理咨询平台
分析完成时间：${new Date().toLocaleString('zh-CN')}
`;

            const blob = new Blob([formattedText], { type: 'text/plain; charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `润藏命理分析报告_${name}_${orderId}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // 下载分析报告为PDF - 修复PDF下载功能
        function downloadPDF() {
            const element = document.getElementById('result-content');
            const serviceType = currentPaymentInfo.serviceName;
            const name = currentUserData.name;
            const orderId = currentPaymentInfo.orderId;
            
            // 保存原始内容
            const originalHTML = element.innerHTML;
            
            // 创建PDF专用内容，确保中文字体
            const pdfContent = document.createElement('div');
            pdfContent.innerHTML = originalHTML;
            pdfContent.style.fontFamily = 'Microsoft YaHei, SimSun, sans-serif';
            pdfContent.style.padding = '20px';
            pdfContent.style.fontSize = '14px';
            pdfContent.style.lineHeight = '1.6';
            
            // 临时显示加载提示
            element.innerHTML = '<div style="text-align: center; padding: 50px; font-family: Microsoft YaHei;"><h3>正在生成PDF文件...</h3><p>请稍候，这可能需要几秒钟时间</p></div>';
            
            const opt = {
                margin: [10, 10, 10, 10],
                filename: `润藏命理分析报告_${name}_${orderId}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2, 
                    useCORS: true,
                    logging: false
                },
                jsPDF: { 
                    unit: 'mm', 
                    format: 'a4', 
                    orientation: 'portrait',
                    compress: true
                }
            };
            
            // 使用html2pdf生成PDF
            html2pdf().set(opt).from(pdfContent).toPdf().get('pdf').then(function(pdf) {
                // 恢复原始内容
                element.innerHTML = originalHTML;
            }).save().catch(error => {
                console.error('PDF生成失败:', error);
                // 恢复原始内容
                element.innerHTML = originalHTML;
                alert('PDF生成失败: ' + error.message + '，请尝试下载文本版本或联系客服');
            });
        }
        
        // 返回首页
        function goToHome() {
            document.getElementById('success-section').style.display = 'none';
            document.getElementById('analysis-process-section').style.display = 'none';
            document.getElementById('info-form').style.display = 'none';
            document.getElementById('user-info-form').reset();
            resetErrors();
            document.querySelectorAll('.payment-option').forEach(option => {
                option.classList.remove('active');
            });
            
            currentPaymentMethod = null;
            
            // 重置加载动画
            document.querySelector('.spinner').style.display = 'block';
            
            // 隐藏API状态
            document.getElementById('api-status').style.display = 'none';
            
            // 滚动到顶部
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // 页面加载完成后初始化
        window.onload = function() {
            generateTimeOptions();
            
            // 添加实时验证
            document.getElementById('name').addEventListener('blur', function() {
                if (!this.value.trim()) {
                    document.getElementById('name-error').style.display = 'block';
                } else {
                    document.getElementById('name-error').style.display = 'none';
                }
            });
            
            // 点击模态框外部关闭模态框
            document.getElementById('payment-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closePaymentModal();
                }
            });
        };
    </script>
</body>
</html>
